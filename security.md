# 보안 가이드

이 문서는 flux-openclaw 프로젝트의 보안 설계와 방어 전략을 기록합니다. OpenClaw의 실제 보안 사고를 분석하여 동일한 취약점을 방지합니다.

## 핵심 원칙

- **기본이 차단, 명시적으로 허용** (Deny by Default): OpenClaw은 "기본이 허용"이라 뚫렸다.
- **최소 권한**: 에이전트에게 필요한 최소한의 권한만 부여한다.
- **심층 방어**: 하나의 방어가 뚫려도 다음 방어가 막는다.

## 코드 실행 격리

- **화이트리스트 명령어**: 시스템 명령은 허용 목록(`ls`, `pwd`, `cat`, `echo`, `python3`)만 실행한다.
- **shell=False 강제**: `subprocess.run()`에서 `shell=True`를 절대 사용하지 않는다.
- **타임아웃 강제**: 모든 코드 실행에 30초 타임아웃을 적용한다.
- **RestrictedPython**: 사용자/에이전트 작성 코드는 `RestrictedPython`으로 위험한 import를 차단한다.
- **향후 Docker 격리**: 복잡해지면 Docker 컨테이너 내에서 코드를 실행한다.

## 경로 탈출 방지 (Path Traversal)

- **워크스페이스 격리**: 모든 파일 접근은 워크스페이스 디렉토리 내부로 제한한다.
- **resolve + is_relative_to**: `Path.resolve()` 후 `is_relative_to(WORKSPACE)` 체크로 `../../etc/passwd` 같은 경로 탈출을 차단한다.
- **심볼릭 링크 차단**: symlink를 따라가지 않는다.

## 스킬 검증

- **위험 패턴 탐지**: 에이전트가 생성한 코드에서 `os.system`, `subprocess.call`, `eval(`, `exec(`, `__import__` 패턴을 자동 검출한다.
- **네트워크 호출 감지**: `requests`, `urllib`, `socket`, `httpx` 등 외부 통신 시도를 감지하고 경고한다.
- **코드 길이 제한**: 스킬 코드는 최대 500줄로 제한한다.
- **실행 전 확인**: 새 스킬 최초 실행 시 사용자 승인을 요청한다.

## 프롬프트 인젝션 방어

- **시스템/사용자 분리**: 시스템 프롬프트와 사용자 입력을 명확한 경계 마커로 분리한다.
- **민감 정보 격리**: API 키, 토큰, .env 내용은 프롬프트에 절대 포함하지 않는다.
- **도구 결과 이스케이프**: 도구 실행 결과를 프롬프트에 삽입할 때 코드블록으로 감싸서 지시문과 구분한다.

## API 키 보호

- **환경변수만 사용**: 모든 키는 `.env` 파일에만 저장하고 코드에 하드코딩하지 않는다.
- **.gitignore 필수**: `.env` 파일을 반드시 `.gitignore`에 등록한다.
- **로그 마스킹**: `sk-`, `sk-ant-`, 토큰 패턴이 로그에 남지 않도록 자동 마스킹한다.
- **log.md 필터링**: 대화 기록에도 키 값이 포함되지 않도록 필터링한다.

## 서버/WebSocket 보안

- **Origin 검증**: WebSocket 연결 시 `origin` 헤더를 허용 목록과 대조한다. (CVE-2026-25253 방지)
- **토큰 인증**: 모든 WebSocket 연결에 인증 토큰을 요구한다.
- **로컬 바인딩**: 기본적으로 `127.0.0.1`에만 바인딩하고, 외부 노출이 필요하면 명시적으로 설정한다.
- **Rate Limiting**: 연결당 분당 최대 요청 수를 제한한다.

## 텔레그램 봇 보안

- **허용 사용자 목록**: 등록된 `chat_id`에서만 명령을 수락한다.
- **미등록 사용자 무시**: 허용 목록에 없는 메시지는 무시하고 로깅만 한다.
- **명령어 제한**: 위험한 도구(Exec, Write)는 텔레그램에서 직접 호출할 수 없다.

## 비용 보호

- **일일 API 호출 상한**: 하루 최대 API 호출 수를 제한한다(기본 100회). OpenClaw에서 하룻밤에 $20 소진된 사례 방지.
- **토큰 사용량 추적**: 누적 토큰 사용량을 기록하고 임계값 초과 시 경고한다.
- **알람 스킬 보호**: 반복 알람이 무한 API 호출을 유발하지 않도록 로컬 TTS만 사용한다.

## OpenClaw 사고 대응표

| OpenClaw 사고 | 원인 | 우리의 방어 |
|--------------|------|------------|
| CVE-2026-25253 (원클릭 RCE) | WebSocket origin 미검증 | origin + 토큰 이중 인증 |
| ClawHavoc (악성 스킬 341개) | 스킬 검증 없음 | 자동 코드 검증 + 사용자 승인 |
| API 키 150만 건 노출 | DB 설정 오류 | .env + 로그 마스킹 + 프롬프트 격리 |
| 명령 인젝션 | shell=True | shell=False + 화이트리스트 |
| 프롬프트 인젝션 | 입력 미분리 | 시스템/사용자 프롬프트 경계 분리 |
| 비용 폭주 ($20/밤) | 호출 제한 없음 | 일일 API 호출 상한 |
| 경로 탈출 | 경로 검증 없음 | resolve() + is_relative_to() |
